<html>
<head>
	<script src="/assets/p5.js"></script>
	<!-- <script src="/assets/p5.speech.js"></script> -->
	<script src="/assets/p5.sound.js"></script>
	<script src="/assets/jquery-1.11.3.min.js"></script>
	<script src="/assets/bootstrap.min.js"></script>
	<link rel="stylesheet" href="/assets/bootstrap.css" media="screen" title="no title" charset="utf-8">
	<script src="/assets/awesomplete.js"></script>
	<script src="/assets/jquery.scrollTo.min.js"></script>
	<script src="/assets/chosen.jquery.min.js"></script>
	<link rel="stylesheet" href="/assets/awesomplete.css" media="screen" title="no title" charset="utf-8">
	<link rel="stylesheet" href="/assets/chosen.css" media="screen" title="no title" charset="utf-8">
	<link rel="stylesheet" href="/assets/simple-sidebar.css" media="screen" title="no title" charset="utf-8">
	<link rel="stylesheet" href="/assets/custom.css" media="screen" title="no title" charset="utf-8">
	<script>
	var thisUrl = window.location.href;
	if (thisUrl.indexOf('?') != -1) {
		var hash = window.location.href.split('?');
		hash = hash[hash.length -1];
		var loadedHaiku;
		$.getJSON ( '/haiku/' + hash, function(data) {
			loadedHaiku = data;
			var lineOne = loadedHaiku[0].join(' ');
			var lineTwo = loadedHaiku[1].join(' ');
			var lineThree = loadedHaiku[2].join(' ');
			var one = ($('#lineOne').val(lineOne));
			var two = ($('#lineTwo').val(lineTwo));
			var three = ($('#lineThree').val(lineThree));
		});
	}

	var folders;
	var b1,
			b2,
			b3;
	var broadcasts = [];
	var all = [];

	var sounds = [];
	var forecastSounds = [];

	var index = 1;
	// var totalWords = 0;
	var errorCounter = 0;
	var storedHaiku = [];
	// var wind = "Fisher, German Bight West, becoming cyclonic 5 to 7, decreasing 3 or 4 for a time Moderate or rough, occasionally very high at first Showers Moderate or good";
	// var wind = "3 or 4 for a time, but mainly northwest 5 to 7";
	var wind = "fisher german bight, I lov 3927947 fh3##$sds s d2";



	// function prepareString() {
	// 	totalWords = 0;
	// 	wind = wind.toLowerCase();
	// 	storedHaiku = wind.split(',');
	// 	for (i=0; i<storedHaiku.length; i++) {
	// 		storedHaiku[i] = storedHaiku[i].trim();
	// 		storedHaiku[i] = storedHaiku[i].split(" ");
	// 		for (j=0; j<storedHaiku[i].length; j++) {
	// 			totalWords ++;
	// 			var test = parseInt(storedHaiku[i][j]) || 0;
	// 			if (test > 0) {
	// 				storedHaiku[i][j] = numberToText(test);
	// 			}
	// 		}
	// 	}
	// }

	// http://stackoverflow.com/questions/1983767/only-keep-a-z-0-9-and-remove-other-characters-from-string-using-javascript
	String.prototype.cleanup = function() {
	   return this.toLowerCase().replace(/[^a-zA-Z0-9]+/g, "-");
	}

	function count(array) {
		var count = 0;
		for(i=0; i<array.length; i++) {
			count += array[i].length;
		}
		return count;
	}

	function prepareString(string) {
		if(string != undefined) {
			string = string.cleanup();
			string = string.split("-");
			return string;
		}
	}

	// storedHaiku.push(prepareString(haiku));

	function storeSound(soundFile) {
		var text = soundFile.file.split("\/");
		text = text[2].split(".")[0];
		soundFile.text = text;
		forecastSounds.push(soundFile);
		if(forecastSounds.length === count(storedHaiku) - errorCounter) {
			console.log("done");
			forecastSounds[0].play();
			forecastSounds[0].onended(playNext);
		}
	}

	function fileExists(path) {
		$.get(path)
		.done(function() {
			var thisSound = loadSound(path, storeSound);
		}).fail(function() {
			errorCounter ++;
		});
	}

	function speak() {
		forecastSounds = [];
		errorCounter = 0;
		for (i=0; i<storedHaiku.length; i++) {
			for (j=0; j<storedHaiku[i].length; j++) {
				var initialPath = '/audio/'
				var path = initialPath + storedHaiku[i][j] + '.mp3';
				fileExists(path);
			}
		}
	}

	function speakOne(word) {
		var initialPath = '/audio/'
		var path = initialPath + word + '.mp3';
		var thisWord = loadSound(path, playOne);
	}

	function playOne(thisWord) {
		thisWord.play();
	}

// 	function preload() {
// 		folders = loadStrings("folder_list.txt", loadFiles);
// 	}
//
// 	function loadFiles(foldersToLoad) {
// 		var folderArray = foldersToLoad[0].split(",");
// 		for(i=0; i<folderArray.length; i++) {
// 			var folderFiles = loadStrings(folderArray[i] + "_list.txt", loadFolderFiles);
// 		}
// 	}
//
// function loadFolderFiles(folderFiles) {
// 	populateSidebar(populateList(folderFiles));
// }

function preload() {
	// b1 = loadStrings("broadcast_0015_list.txt", loadFilesB1);
	// b2 = loadStrings("broadcast_1130_list.txt", loadFilesB2);
	// b3 = loadStrings("broadcast_1725_list.txt", loadFilesB3);
	b1 = loadStrings("broadcast_0015_list.txt", loadFilesB1);
	b2 = loadStrings("broadcast_1130_list.txt", loadFilesB2);
	b3 = loadStrings("broadcast_1725_list.txt", loadFilesB3);
}
var b1Load = false;
var b2Load = false;
var b3Load = false;

function loadFilesB1(folderFiles) {
	// populateSidebar(populateList(folderFiles), "broadcast_0015");
	b1Load = true;
}
function loadFilesB2(folderFiles) {
	// populateSidebar(populateList(folderFiles), "broadcast_1130");
	b2Load = true;
}
function loadFilesB3(folderFiles) {
	// populateSidebar(populateList(folderFiles), "broadcast_1725");
	b3Load = true;
	while(b1Load === true && b2Load === true) {
		b1 = populateList(b1, "0015");
		b2 = populateList(b2, "1130");
		b3 = populateList(b3, "1725");
		all = b1.concat(b2, b3);
		populateSidebar(all);
		b1Load = false;
		b2Load = false;
		b3Load = false;
	}
}

//http://stackoverflow.com/questions/16096872/how-to-sort-2-dimensional-array-by-column-value
function sortFunction(a, b) {
    if (a[0] === b[0]) {
        return 0;
    }
    else {
        return (a[0] < b[0]) ? -1 : 1;
    }
}

function arrayToObj(array) {
	var obj = array.reduce(function(o, v, i) {
		o[i] = v;
		return o;
	}, {});
	return obj;
}

	function setup()
	{
		noCanvas();
	}

	function playNext() {
		forecastSounds[index].play();
		if(index < forecastSounds.length - 1) {
			forecastSounds[index].onended(playNext);
			index++;
		} else if (index === forecastSounds.length -1) {
			index = 1;
		}
	}

	function numberToText(number) {
		switch (parseInt(number)) {
			case 0:
			return "zero";
			break;
			case 1:
			return "one";
			break;
			case 2:
			return "two";
			break;
			case 3:
			return "three";
			break;
			case 4:
			return "four";
			break;
			case 5:
			return "five";
			break;
			case 6:
			return "six";
			break;
			case 7:
			return "seven";
			break;
			case 8:
			return "eight";
			break;
			case 9:
			return "nine";
			break;
			case 10:
			return "ten";
			break;
			default:
			return;
		}
	}

	// function populateList(files) {
	// 	files = files[0].split(",");
	// 	// files.shift();
	// 	for(i=0; i<files.length; i++) {
	// 		if(files[i].search("\_") === -1 && files[i].search("\]") === -1) { //remove files that have _ or ]
	// 			files[i] = files[i].split(".")[0];
	// 		} else {
	// 			// removing files
	// 			files.splice(i,1);
	// 			// remember to reverse iterate! (subtract one from i because array has jsut shifted with splice)
	// 			// http://stackoverflow.com/questions/9882284/looping-through-array-and-removing-items-without-breaking-for-loop
	// 			i--;
	// 		}
	// 	}
	// 	return files;
	// }

	function populateList(files, filePath) {
		files = files[0].split(",");
		// files.shift();
		for(i=0; i<files.length; i++) {
			if(files[i].search("\_") === -1 && files[i].search("\]") === -1) { //remove files that have _ or ]
				files[i] = files[i].split(".")[0];
				files[i] = [files[i], filePath];
			} else {
				// removing files
				files.splice(i,1);
				// remember to reverse iterate! (subtract one from i because array has jsut shifted with splice)
				// http://stackoverflow.com/questions/9882284/looping-through-array-and-removing-items-without-breaking-for-loop
				i--;
			}
		}
		return files;
	}

		// function populateSidebar(array) {
		// 	for(i=0; i<array.length; i++) {
		// 		$('.sidebar-nav').append('<li class="words-link">\
		// 		<a href="#" data-path="' + array[i] + '">' + array[i] + '</a>\
		// 		</li>')
		// 		// <input type="checkbox" name="' + array[i] + '" value="' + array[i] + '">\
		// 	}
		// 	$('.words-link a').click(function(){
		// 		var soundPath = $(this).attr('data-path');
		// 		speakOne(soundPath);
		// 	});
		// }

		// http://stackoverflow.com/questions/16096872/how-to-sort-2-dimensional-array-by-column-value
		function sortByFirstColumn(a, b) {
			if (a[0] === b[0]) {
				return 0;
			}
			else {
				return (a[0] < b[0]) ? -1 : 1;
			}
		}

		function populateSidebar(array) {
			array.sort(sortByFirstColumn);
			for(i=0; i<array.length; i++) {
				$('.sidebar-nav').append('<li class="words-link">' +
				'<a href="#" id="broadcast_' + array[i][1] + "\/" + array[i][0] + '">' +
				'<input type="checkbox" class="audiobox" name="' + array[i][0] + '" value="broadcast_' + array[i][1] + "\/" + array[i][0] + '">&nbsp;' +
					array[i][0] + '</a>' +
				'</li>')

				$('#selectOne').append('<option value="broadcast_' + array[i][1] + "\/" + array[i][0] + '">' + array[i][0] + '</option>');
				$('#selectTwo').append('<option value="broadcast_' + array[i][1] + "\/" + array[i][0] + '">' + array[i][0] + '</option>');
				$('#selectThree').append('<option value="broadcast_' + array[i][1] + "\/" + array[i][0] + '">' + array[i][0] + '</option>');

			}
			$('.words-link a').click(function(){
				var soundPath = $(this).attr('id');
				//scroll to clicked
				// $('#sidebar-wrapper').scrollTo($('a[id*="broadcast_1130/agency"]'),500);
				// $('#sidebar-wrapper').scrollTo($(this),500);
				speakOne(soundPath);
			});
			$('.site-wrapper').fadeIn(1500);
			$('#selectOne').chosen({
				max_selected_options: 7
			});
			$('#selectTwo').chosen();
			$('#selectThree').chosen();
		}

		// populateSidebar(files);

		//another approach to autocomplete: http://harvesthq.github.io/chosen/
		//create autocomplete dropdown
		function createAutocomplete (input, files) {
			var awesomplete = new Awesomplete(input);
			awesomplete.filter = function(text, input) {
				return Awesomplete.FILTER_CONTAINS(text, input.match(/[^ ]*$/)[0]);
			}

			awesomplete.replace = function(text) {
				var before = this.input.value.match(/^.+ \s*|/)[0];
				this.input.value = before + text + " ";
			}
			awesomplete.minChars = 1;
			awesomplete.maxItems = 10;
			awesomplete.list = files;
		}
		// var inputs = $("input");
		// for(i=0; i<inputs.length; i++) {
		// 	createAutocomplete(inputs[i]);
		// }
		//
		$('#haiku-body').fadeIn(1500);


	// function getInputs() {
	// 	var one = ($('#lineOne').val()).trim();
	// 	var two = ($('#lineTwo').val()).trim();
	// 	var three = ($('#lineThree').val()).trim();
	// 	storedHaiku = [];
	// 	storedHaiku.push(prepareString(one));
	// 	storedHaiku.push(prepareString(two));
	// 	storedHaiku.push(prepareString(three));
	// }

	function getInputs() {
		var one = ($('#selectOne').val());
		var two = ($('#selectTwo').val());
		var three = ($('#selectThree').val());
		storedHaiku = [];
		storedHaiku.push(one);
		storedHaiku.push(two);
		storedHaiku.push(three);
	}

	function listen() {
		getInputs();
		speak();
	}

	function listenSelected() {
		$('input:checkbox.audiobox').each(function () {
			if(this.checked) {
				speakOne($(this).val());
				// $(this).attr('checked', false);
			};
		});
	}

	function resetCheckboxes() {
		$('input:checkbox.audiobox').each(function () {
			if(this.checked) {
				$(this).attr('checked', false);
			};
		});
	}

	var thisHaikuId;
	var posted = false;

	function createPermalink(id) {
		// $('#link').append('<p>Done! Check out your haiku <a href=haiku/' + id + '>here</a>.</p>	')
		$('#link').append('<p>Done! Check out your haiku <a href=?' + id + '>here</a>.</p>	');
		// $('.custom-list').prepend('<input id="title" data-multiple class="haiku-input title-input" placeholder="title (optional)"/>');
		$('#link').fadeIn(1500);
		// $('#title').fadeIn(1500);
	}

	function formatData(array) {
		// http://stackoverflow.com/questions/4215737/convert-array-to-object
		// user Pointy
		var obj = array.reduce(function(o, v, i) {
		  o[i] = v;
		  return o;
		}, {});
		var objString = JSON.stringify(obj);
		return objString;
}
	function postData(jsonObj) {
		if (posted === true) return;
		$.ajax({
		type: "POST",
		url: "/share",
		data: jsonObj,
		contentType: "application/json; charset=utf-8",
		dataType: "json",
		success: function (data) {
		thisHaikuId = data.haikuId;
		createPermalink(thisHaikuId);
		posted = true;
		},
		failure: function(errMsg) {
				alert(errMsg);
		}
	});
	}

	function share () {
		getInputs();
		postData(formatData(storedHaiku));
	}



	</script>
</head>
<body style="overflow:hidden;">
	<!-- <div class="site-wrapper">

	<div class="site-wrapper-inner">

	<div class="cover-container">

	<div class="masthead clearfix">
	<div class="inner">
	<h3 class="masthead-brand">Cover</h3>
	<nav>
	<ul class="nav masthead-nav">
	<li class="active"><a href="#">Home</a></li>
	<li><a href="#">Features</a></li>
	<li><a href="#">Contact</a></li>
</ul>
</nav>
</div>
</div>

<div class="inner cover">
<ul>
<li><input id="lineOne" data-multiple class="haiku-input"/></li>
<li><input id="lineTwo" data-multiple class="haiku-input"/></li>
<li><input id="lineThree" data-multiple class="haiku-input"/></li>
</ul>
</div>

<div class="mastfoot">
<div class="inner">
<p>Cover template for <a href="http://getbootstrap.com">Bootstrap</a>, by <a href="https://twitter.com/mdo">@mdo</a>.</p>
</div>
</div>

</div>

</div>

</div> -->

<div class="site-wrapper" style="display:none;">

	<!-- Sidebar -->
<div id="sidebar-wrapper">
		<ul class="sidebar-nav">
				<li class="sidebar-brand" style="height:30px">
					<button id="listenSelected-btn" type="button" name="button" class="btn icons-button" onclick="listenSelected();" data-original-title="Listen" data-placement="left" data-toggle="tooltip" style="position:fixed; margin-left:160px; margin-top:15px">
						<span class="glyphicon glyphicon-volume-up" aria-hidden="true"></span>
					</button>
					<button id="remove-btn" type="button" name="button" class="btn icons-button" onclick="resetCheckboxes();" data-original-title="Reset" data-placement="left" data-toggle="tooltip" style="position:fixed; margin-left:160px; margin-top:60px">
						<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
					</button>
						<!-- <a href="#">
								Words
						</a> -->
						<!-- <a href="#" style="position:fixed; margin-left:150px;">
								Words
						</a> -->

				</li>
		</ul>
</div>
<!-- /#sidebar-wrapper -->

	<div class="site-wrapper-inner">
		<div class="cover-container">



			<div class="inner cover" id="haiku-body" >
				<ul class="custom-list">
					<!-- <li><input id="lineOne" data-multiple class="haiku-input" placeholder="type in your"/></li> -->
					<!-- <li><input id="lineTwo" data-multiple class="haiku-input" placeholder="shipping forecast inspired"/></li> -->
					<!-- <li><input id="lineThree" data-multiple class="haiku-input" placeholder="haiku here"/></li> -->
					<li><select multiple id="selectOne" class="haiku-select" data-placeholder="type in your">
						<option value></option>
					</select>
					<li><select multiple id="selectTwo" class="haiku-select" data-placeholder="shipping forecast inspired">
						<option value></option>
					</select>
					<li><select multiple id="selectThree" class="haiku-select" data-placeholder="haiku here">
						<option value></option>
					</select>
					</li>
				</ul>
				<button id="listen-btn" type="button" name="button" class="btn icons-button" onclick="listen();" data-original-title="Listen" data-placement="bottom" data-toggle="tooltip">
					<span class="glyphicon glyphicon-volume-up" aria-hidden="true"></span>
				</button>
				<span style="float:right;">
					<button id="info-btn" type="button" name="button" class="btn icons-button" onclick="hello();" data-original-title="Info" data-placement="bottom" data-toggle="tooltip">
						<span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
					</button>
					<button id="other-btn" type="button" name="button" class="btn icons-button" onclick="others();" data-original-title="Hear other haiku" data-placement="bottom" data-toggle="tooltip">
						<span class="glyphicon glyphicon-th" aria-hidden="true"></span>
					</button>
					<button id="share-btn" type="button" name="button" class="btn icons-button" onclick="share();" data-original-title="Share" data-placement="bottom" data-toggle="tooltip">
						<span class="glyphicon glyphicon-share" aria-hidden="true"></span>
					</button>
				</span>
				<div style="color:#fff; margin-top:0.5em; float:right;">
					<p id="link" style="display:none;"></p>
				</div>
			</div>

			<div class="mastfoot">
				<div class="inner">
					<!-- <p><a href="/about.html">More about</a> the Haiku Forecast, by <a href="https://bernardol.com/">@bernardol</a>.</p> -->
				</div>
			</div>

		</div>
	</div>
</div>
<script type="text/javascript">
$(document).ready(function() {
	$('button').tooltip();
});
</script>
</body>
</html>
